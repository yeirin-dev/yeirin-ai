name: Deploy Yeirin-AI Backend

on:
  push:
    branches:
      - deploy/dev
  workflow_dispatch:

env:
  EC2_HOST: 43.203.210.136
  EC2_USER: ec2-user
  APP_DIR: /home/ec2-user/app/yeirin-ai

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy code via rsync
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='*.pyc' \
            --exclude='.env' \
            ./ ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.APP_DIR }}/

      - name: Install dependencies and restart with PM2
        run: |
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e

            echo "=== Starting Yeirin-AI Backend Deployment ==="
            cd /home/ec2-user/app/yeirin-ai

            # Install Node.js if not exists (required for PM2)
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
              sudo dnf install -y nodejs
            fi

            # Install uv if not exists
            if ! command -v uv &> /dev/null; then
              echo "Installing uv..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
            fi
            export PATH="$HOME/.local/bin:$PATH"

            # Install PM2 globally if not exists
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            # Sync dependencies
            echo "Installing dependencies..."
            uv sync --frozen

            # Install Playwright browsers
            echo "Installing Playwright browsers..."
            uv run playwright install chromium

            # Load environment from SSM and create .env
            echo "Loading environment from SSM Parameter Store..."
            export AWS_DEFAULT_REGION=ap-northeast-2

            # Generate .env file
            cat > .env << EOF
          DEBUG=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/debug" --query "Parameter.Value" --output text)
          PORT=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/port" --query "Parameter.Value" --output text)
          LOG_LEVEL=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/log-level" --query "Parameter.Value" --output text)
          APP_NAME=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/app-name" --query "Parameter.Value" --output text)
          APP_VERSION=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/app-version" --query "Parameter.Value" --output text)
          DATABASE_URL=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/database-url" --with-decryption --query "Parameter.Value" --output text)
          OPENAI_API_KEY=$(aws ssm get-parameter --name "/yeirin/dev/common/openai-api-key" --with-decryption --query "Parameter.Value" --output text)
          OPENAI_MODEL=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/openai-model" --query "Parameter.Value" --output text)
          INTERNAL_API_SECRET=$(aws ssm get-parameter --name "/yeirin/dev/common/internal-api-secret" --with-decryption --query "Parameter.Value" --output text)
          YEIRIN_BACKEND_URL=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/yeirin-backend-url" --query "Parameter.Value" --output text)
          SOUL_E_WEBHOOK_URL=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/soul-e-webhook-url" --query "Parameter.Value" --output text)
          CORS_ORIGINS=$(aws ssm get-parameter --name "/yeirin/dev/yeirin-ai/cors-origins" --query "Parameter.Value" --output text)
          EOF

            echo "Environment file created."

            # Stop existing systemd service if running
            sudo systemctl stop yeirin-ai 2>/dev/null || true
            sudo systemctl disable yeirin-ai 2>/dev/null || true

            # Restart with PM2
            echo "Restarting with PM2..."
            pm2 delete yeirin-ai 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            # Setup PM2 startup
            pm2 startup systemd -u ec2-user --hp /home/ec2-user 2>/dev/null || true

            # Wait and check status
            sleep 5
            pm2 status

            echo "=== Deployment completed! ==="
          ENDSSH

      - name: Health Check
        run: |
          echo "Waiting for service to start..."
          sleep 15
          echo "Running health check..."
          curl -f http://${{ env.EC2_HOST }}:8001/api/v1/health || exit 1
          echo "Health check passed!"
