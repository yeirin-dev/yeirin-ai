name: Deploy Yeirin-AI Backend

on:
  push:
    branches:
      - deploy/dev
  workflow_dispatch:

env:
  EC2_HOST: 43.203.210.136
  EC2_USER: ec2-user
  APP_DIR: /home/ec2-user/app/yeirin-ai

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Send GitHub Token to EC2
        run: |
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "echo '${{ secrets.GH_DEPLOY_TOKEN }}' > /tmp/.gh_token && chmod 600 /tmp/.gh_token"

      - name: Deploy via Git Pull, install and restart with PM2
        run: |
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            GH_TOKEN=$(cat /tmp/.gh_token)
            rm -f /tmp/.gh_token

            echo "=== Starting Yeirin-AI Backend Deployment ==="

            # Create app directory if not exists
            mkdir -p /home/ec2-user/app/yeirin-ai
            cd /home/ec2-user/app/yeirin-ai

            # Clone or pull latest code using GitHub token
            if [ -d ".git" ]; then
              echo "Pulling latest changes..."
              git remote set-url origin "https://${GH_TOKEN}@github.com/yeirin-dev/yeirin-ai-backend.git"
              git fetch origin deploy/dev
              git reset --hard origin/deploy/dev
            else
              # Clean up old rsync deployment if exists
              echo "Cleaning up old deployment..."
              rm -rf /home/ec2-user/app/yeirin-ai/*
              rm -rf /home/ec2-user/app/yeirin-ai/.[!.]*
              echo "Cloning repository..."
              git clone -b deploy/dev "https://${GH_TOKEN}@github.com/yeirin-dev/yeirin-ai-backend.git" .
            fi

            echo "Current commit:"
            git log --oneline -1

            # Install Node.js if not exists (required for PM2)
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
              sudo dnf install -y nodejs
            fi

            # Install uv if not exists
            if ! command -v uv &> /dev/null; then
              echo "Installing uv..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
            fi
            export PATH="$HOME/.local/bin:$PATH"

            # Install PM2 globally if not exists
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            # Sync dependencies
            echo "Installing dependencies..."
            uv sync --frozen

            # Install Playwright browsers
            echo "Installing Playwright browsers..."
            uv run playwright install chromium

            # Load environment from SSM and create .env
            echo "Loading environment from SSM Parameter Store..."
            export AWS_DEFAULT_REGION=ap-northeast-2

            # Generate .env file using separate commands
            echo "DEBUG=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/debug' --query 'Parameter.Value' --output text --region ap-northeast-2)" > .env
            echo "PORT=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/port' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "LOG_LEVEL=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/log-level' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "APP_NAME=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/app-name' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "APP_VERSION=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/app-version' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "DATABASE_URL=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/database-url' --with-decryption --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "OPENAI_API_KEY=$(aws ssm get-parameter --name '/yeirin/dev/common/openai-api-key' --with-decryption --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "OPENAI_MODEL=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/openai-model' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "INTERNAL_API_SECRET=$(aws ssm get-parameter --name '/yeirin/dev/common/internal-api-secret' --with-decryption --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "YEIRIN_BACKEND_URL=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/yeirin-backend-url' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "SOUL_E_WEBHOOK_URL=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/soul-e-webhook-url' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env
            echo "CORS_ORIGINS=$(aws ssm get-parameter --name '/yeirin/dev/yeirin-ai/cors-origins' --query 'Parameter.Value' --output text --region ap-northeast-2)" >> .env

            echo "Environment file created."
            cat .env | head -5

            # Stop existing systemd service if running
            sudo systemctl stop yeirin-ai 2>/dev/null || true
            sudo systemctl disable yeirin-ai 2>/dev/null || true

            # Restart with PM2
            echo "Restarting with PM2..."
            pm2 delete yeirin-ai 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            # Setup PM2 startup
            pm2 startup systemd -u ec2-user --hp /home/ec2-user 2>/dev/null || true

            # Wait and check status
            sleep 5
            pm2 status
            pm2 logs yeirin-ai --lines 10 --nostream || true

            echo "=== Deployment completed! ==="
          ENDSSH

      - name: Health Check
        run: |
          echo "Waiting for service to start..."
          sleep 15
          echo "Running health check..."
          curl -f http://${{ env.EC2_HOST }}:8001/api/v1/health || exit 1
          echo "Health check passed!"
